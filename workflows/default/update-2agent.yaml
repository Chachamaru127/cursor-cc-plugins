# /update-2agent ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©
# æ—¢å­˜ã®2ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½“åˆ¶ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’æ›´æ–°

phase: update-2agent
description: "æ—¢å­˜ã®2ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½“åˆ¶ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã™ã‚‹ï¼ˆå·®åˆ†ãƒãƒ¼ã‚¸å¯¾å¿œï¼‰"

steps:
  # Step 1: Case-Insensitive ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
  - id: detect-existing-files
    skill: ccp-update-2agent-files
    input:
      detect_patterns:
        - pattern: "agents.md"
          standard: "AGENTS.md"
        - pattern: "claude.md"
          standard: "CLAUDE.md"
        - pattern: "plans.md"
          standard: "Plans.md"
      context_from:
        - repo_tree
        - plugin_version
    output:
      variables:
        - detected_files      # { agents: "./AGENTS.md", claude: null, plans: "./plans.md" }
        - needs_normalization # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ­£è¦åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹
        - setup_status        # not_installed | current | outdated
        - installed_version
        - plugin_version
    mode: required

  # Step 2: æ›´æ–°åˆ¤å®š
  - id: check-update-needed
    skill: ccp-update-2agent-files
    input:
      variables:
        - setup_status
        - installed_version
        - plugin_version
      force_update: "{{force_option}}"  # --force ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    output:
      variables:
        - should_proceed
        - update_reason  # outdated | force | not_needed | not_installed
    mode: required

  # Step 3: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
  - id: create-backup
    skill: ccp-update-2agent-files
    condition: "should_proceed"
    input:
      detected_files: "{{detected_files}}"
      backup_dir: ".cursor-cc-backup-{{timestamp}}"
    output:
      variables:
        - backup_path
        - backup_files
    mode: required

  # Step 4: Plans.md ã®ãƒãƒ¼ã‚¸æ›´æ–°
  - id: merge-plans
    skill: ccp-merge-plans
    condition: "should_proceed && detected_files.plans"
    input:
      existing_file: "{{detected_files.plans}}"
      template: "templates/Plans.md.template"
      variables:
        - project_name
        - date
    output:
      variables:
        - tasks_preserved  # { wip: 2, todo: 5, done: 10, archive: 3 }
        - merge_successful
    mode: required

  # Step 5: AGENTS.md / CLAUDE.md ã®æ›´æ–°
  - id: update-workflow-files
    skill: ccp-generate-workflow-files
    condition: "should_proceed"
    input:
      templates:
        - templates/AGENTS.md.template
        - templates/CLAUDE.md.template
      variables:
        - project_name
        - date
      overwrite: true
      normalize_filenames: "{{needs_normalization}}"
      old_files: "{{detected_files}}"
    output:
      create_files:
        - AGENTS.md
        - CLAUDE.md
      variables:
        - normalized_files  # ãƒªãƒãƒ¼ãƒ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
    mode: required

  # Step 6: Cursor ã‚³ãƒãƒ³ãƒ‰ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°
  - id: update-support-files
    skill: ccp-setup-2agent-files
    condition: "should_proceed"
    input:
      templates:
        - templates/cursor/commands/assign-to-cc.md
        - templates/cursor/commands/review-cc-work.md
      variables:
        - plugin_version
        - date
        - project_name
        - installed_version  # æ›´æ–°å…ƒãƒãƒ¼ã‚¸ãƒ§ãƒ³
      update_mode: true
    output:
      create_files:
        - .cursor/commands/assign-to-cc.md
        - .cursor/commands/review-cc-work.md
        - .cursor-cc-version
    mode: required

# æˆåŠŸæ™‚ã®å‡ºåŠ›
on_success:
  message: |
    âœ… **2ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½“åˆ¶ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼** (v{{installed_version}} â†’ v{{plugin_version}})

    ğŸ“ **æ›´æ–°å†…å®¹**:
    - AGENTS.md: æ§‹é€ ã‚’æ›´æ–°
    - CLAUDE.md: æ§‹é€ ã‚’æ›´æ–°
    - Plans.md: ã‚¿ã‚¹ã‚¯ã‚’ä¿æŒã—ã¤ã¤æ§‹é€ ã‚’æ›´æ–°
    - .cursor/commands/: æœ€æ–°ç‰ˆã«æ›´æ–°

    ğŸ“‹ **ä¿æŒã•ã‚ŒãŸã‚¿ã‚¹ã‚¯**:
    - é€²è¡Œä¸­: {{tasks_preserved.wip}}ä»¶
    - æœªç€æ‰‹: {{tasks_preserved.todo}}ä»¶
    - å®Œäº†: {{tasks_preserved.done}}ä»¶
    - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–: {{tasks_preserved.archive}}ä»¶

    ğŸ“¦ **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: `{{backup_path}}`

    ğŸ’¡ å•é¡ŒãŒã‚ã‚Œã°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã§ãã¾ã™

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ãªã„å ´åˆ
on_not_installed:
  message: |
    âš ï¸ **2ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½“åˆ¶ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã›ã‚“**

    ã¾ãš `/setup-2agent` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

# æ—¢ã«æœ€æ–°ç‰ˆã®å ´åˆ
on_current:
  message: |
    âœ… **æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (v{{plugin_version}}) ã§ã™**

    å¼·åˆ¶çš„ã«æ›´æ–°ã™ã‚‹å ´åˆã¯ã€Œå¼·åˆ¶æ›´æ–°ã—ã¦ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚

# ãƒ•ã‚¡ã‚¤ãƒ«åæ­£è¦åŒ–ã®ç¢ºèª
on_normalization_needed:
  message: |
    ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«åã®æ­£è¦åŒ–ãŒå¿…è¦ã§ã™**

    æ¤œå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:
    {{#each detected_files}}
    - `{{this.found}}` â†’ `{{this.standard}}`
    {{/each}}

    æ­£è¦åŒ–ã—ã¾ã™ã‹ï¼Ÿ (y/n)

# ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡ºåŠ›
on_error:
  message: |
    âš ï¸ **æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**

    ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒ `{{backup_path}}` ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
    å¾©å…ƒã™ã‚‹å ´åˆã¯ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¦ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚

    è©³ç´°: {{error_message}}
